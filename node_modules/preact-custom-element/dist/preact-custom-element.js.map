{"version":3,"file":"preact-custom-element.js","sources":["../src/index.js"],"sourcesContent":["import { h, cloneElement, render, hydrate } from 'preact';\r\n\r\nexport default function register(Component, tagName, propNames, options) {\r\n\tfunction PreactElement() {\r\n\t\tconst inst = Reflect.construct(HTMLElement, [], PreactElement);\r\n\t\tinst._vdomComponent = Component;\r\n\t\tinst._root =\r\n\t\t\toptions && options.shadow ? inst.attachShadow({ mode: options.mode || 'open' }) : inst;\r\n\t\treturn inst;\r\n\t}\r\n\tPreactElement.prototype = Object.create(HTMLElement.prototype);\r\n\tPreactElement.prototype.constructor = PreactElement;\r\n\tPreactElement.prototype.connectedCallback = connectedCallback;\r\n\tPreactElement.prototype.attributeChangedCallback = attributeChangedCallback;\r\n\tPreactElement.prototype.disconnectedCallback = disconnectedCallback;\r\n\r\n\tpropNames =\r\n\t\tpropNames ||\r\n\t\tComponent.observedAttributes ||\r\n\t\tObject.keys(Component.propTypes || {});\r\n\tPreactElement.observedAttributes = propNames;\r\n\r\n\t// Keep DOM properties and Preact props in sync\r\n\tpropNames.forEach((name) => {\r\n\t\tObject.defineProperty(PreactElement.prototype, name, {\r\n\t\t\tget() {\r\n\t\t\t\treturn this._vdom.props[name];\r\n\t\t\t},\r\n\t\t\tset(v) {\r\n\t\t\t\tif (this._vdom) {\r\n\t\t\t\t\tthis.attributeChangedCallback(name, null, v);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (!this._props) this._props = {};\r\n\t\t\t\t\tthis._props[name] = v;\r\n\t\t\t\t\tthis.connectedCallback();\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Reflect property changes to attributes if the value is a primitive\r\n\t\t\t\tconst type = typeof v;\r\n\t\t\t\tif (\r\n\t\t\t\t\tv == null ||\r\n\t\t\t\t\ttype === 'string' ||\r\n\t\t\t\t\ttype === 'boolean' ||\r\n\t\t\t\t\ttype === 'number'\r\n\t\t\t\t) {\r\n\t\t\t\t\tthis.setAttribute(name, v);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t});\r\n\t});\r\n\r\n\treturn customElements.define(\r\n\t\ttagName || Component.tagName || Component.displayName || Component.name,\r\n\t\tPreactElement\r\n\t);\r\n}\r\n\r\nfunction ContextProvider(props) {\r\n\tthis.getChildContext = () => props.context;\r\n\t// eslint-disable-next-line no-unused-vars\r\n\tconst { context, children, ...rest } = props;\r\n\treturn cloneElement(children, rest);\r\n}\r\n\r\nfunction connectedCallback() {\r\n\t// Obtain a reference to the previous context by pinging the nearest\r\n\t// higher up node that was rendered with Preact. If one Preact component\r\n\t// higher up receives our ping, it will set the `detail` property of\r\n\t// our custom event. This works because events are dispatched\r\n\t// synchronously.\r\n\tconst event = new CustomEvent('_preact', {\r\n\t\tdetail: {},\r\n\t\tbubbles: true,\r\n\t\tcancelable: true,\r\n\t});\r\n\tthis.dispatchEvent(event);\r\n\tconst context = event.detail.context;\r\n\r\n\tthis._vdom = h(\r\n\t\tContextProvider,\r\n\t\t{ ...this._props, context },\r\n\t\ttoVdom(this, this._vdomComponent)\r\n\t);\r\n\t(this.hasAttribute('hydrate') ? hydrate : render)(this._vdom, this._root);\r\n}\r\n\r\nfunction toCamelCase(str) {\r\n\treturn str.replace(/-(\\w)/g, (_, c) => (c ? c.toUpperCase() : ''));\r\n}\r\n\r\nfunction attributeChangedCallback(name, oldValue, newValue) {\r\n\tif (!this._vdom) return;\r\n\t// Attributes use `null` as an empty value whereas `undefined` is more\r\n\t// common in pure JS components, especially with default parameters.\r\n\t// When calling `node.removeAttribute()` we'll receive `null` as the new\r\n\t// value. See issue #50.\r\n\tnewValue = newValue == null ? undefined : newValue;\r\n\tconst props = {};\r\n\tprops[name] = newValue;\r\n\tprops[toCamelCase(name)] = newValue;\r\n\tthis._vdom = cloneElement(this._vdom, props);\r\n\trender(this._vdom, this._root);\r\n}\r\n\r\nfunction disconnectedCallback() {\r\n\trender((this._vdom = null), this._root);\r\n}\r\n\r\n/**\r\n * Pass an event listener to each `<slot>` that \"forwards\" the current\r\n * context value to the rendered child. The child will trigger a custom\r\n * event, where will add the context value to. Because events work\r\n * synchronously, the child can immediately pull of the value right\r\n * after having fired the event.\r\n */\r\nfunction Slot(props, context) {\r\n\tconst ref = (r) => {\r\n\t\tif (!r) {\r\n\t\t\tthis.ref.removeEventListener('_preact', this._listener);\r\n\t\t} else {\r\n\t\t\tthis.ref = r;\r\n\t\t\tif (!this._listener) {\r\n\t\t\t\tthis._listener = (event) => {\r\n\t\t\t\t\tevent.stopPropagation();\r\n\t\t\t\t\tevent.detail.context = context;\r\n\t\t\t\t};\r\n\t\t\t\tr.addEventListener('_preact', this._listener);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\treturn h('slot', { ...props, ref });\r\n}\r\n\r\nfunction toVdom(element, nodeName) {\r\n\tif (element.nodeType === 3) return element.data;\r\n\tif (element.nodeType !== 1) return null;\r\n\tlet children = [],\r\n\t\tprops = {},\r\n\t\ti = 0,\r\n\t\ta = element.attributes,\r\n\t\tcn = element.childNodes;\r\n\tfor (i = a.length; i--; ) {\r\n\t\tif (a[i].name !== 'slot') {\r\n\t\t\tprops[a[i].name] = a[i].value;\r\n\t\t\tprops[toCamelCase(a[i].name)] = a[i].value;\r\n\t\t}\r\n\t}\r\n\r\n\tfor (i = cn.length; i--; ) {\r\n\t\tconst vnode = toVdom(cn[i], null);\r\n\t\t// Move slots correctly\r\n\t\tconst name = cn[i].slot;\r\n\t\tif (name) {\r\n\t\t\tprops[name] = h(Slot, { name }, vnode);\r\n\t\t} else {\r\n\t\t\tchildren[i] = vnode;\r\n\t\t}\r\n\t}\r\n\r\n\t// Only wrap the topmost node with a slot\r\n\tconst wrappedChildren = nodeName ? h(Slot, null, children) : children;\r\n\treturn h(nodeName || element.nodeName.toLowerCase(), props, wrappedChildren);\r\n}\r\n"],"names":["ContextProvider","props","this","getChildContext","context","children","rest","_objectWithoutPropertiesLoose","_excluded","cloneElement","connectedCallback","event","CustomEvent","detail","bubbles","cancelable","dispatchEvent","_vdom","h","_extends","_props","toVdom","element","nodeName","nodeType","data","i","a","attributes","cn","childNodes","length","name","value","toCamelCase","vnode","slot","Slot","wrappedChildren","toLowerCase","_vdomComponent","hasAttribute","hydrate","render","_root","str","replace","_","c","toUpperCase","attributeChangedCallback","oldValue","newValue","undefined","disconnectedCallback","_this","ref","r","_listener","stopPropagation","addEventListener","removeEventListener","Component","tagName","propNames","options","PreactElement","inst","Reflect","construct","HTMLElement","shadow","attachShadow","mode","prototype","Object","create","constructor","observedAttributes","keys","propTypes","forEach","defineProperty","get","set","v","type","setAttribute","customElements","define","displayName"],"mappings":"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"}